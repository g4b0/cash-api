openapi: 3.0.3
info:
  title: Cash API
  description: Backend for small-community (e.g. family) shared finances management
  version: 1.0.0
  contact:
    name: Cash API
servers:
  - url: http://localhost:8000
    description: Local development server

tags:
  - name: Authentication
    description: User authentication and token management
  - name: Dashboard
    description: Member financial dashboard
  - name: Income
    description: Income record management
  - name: Expense
    description: Expense record management

paths:
  /login:
    post:
      tags:
        - Authentication
      summary: Authenticate user and get JWT tokens
      description: Validates username and password, returns access and refresh tokens
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  example: testuser
                password:
                  type: string
                  format: password
                  example: password123
      responses:
        '200':
          description: Authentication successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken:
                    type: string
                    description: JWT access token (1 hour expiry)
                    example: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...
                  refreshToken:
                    type: string
                    description: JWT refresh token (7 days expiry)
                    example: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...
        '400':
          description: Missing username or password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /refresh:
    post:
      tags:
        - Authentication
      summary: Refresh JWT tokens
      description: Accepts a refresh token and returns new access and refresh tokens
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refreshToken
              properties:
                refreshToken:
                  type: string
                  description: Valid refresh token
                  example: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...
      responses:
        '200':
          description: Tokens refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken:
                    type: string
                    description: New JWT access token
                  refreshToken:
                    type: string
                    description: New JWT refresh token
        '400':
          description: Refresh token required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /balance/{communityId}/{member_id}:
    get:
      tags:
        - Dashboard
      summary: Get member's balance
      description: Returns calculated balance for a member. User must belong to the same community as the requested member.
      security:
        - BearerAuth: []
      parameters:
        - name: communityId
          in: path
          required: true
          schema:
            type: integer
          description: Community ID
          example: 1
        - name: member_id
          in: path
          required: true
          schema:
            type: integer
          description: Member ID
          example: 1
      responses:
        '200':
          description: Balance retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  balance:
                    type: number
                    format: float
                    description: Calculated balance (positive = debit, negative = credit)
                    example: 750.5
        '401':
          description: Unauthorized - missing or invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - user not in same community as requested member
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not Found - member does not exist
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /transactions/{communityId}/{member_id}:
    get:
      tags:
        - Dashboard
      summary: Get paginated list of member's transactions
      description: Returns merged income and expense transactions sorted by date descending. User must belong to the same community as the requested member.
      security:
        - BearerAuth: []
      parameters:
        - name: communityId
          in: path
          required: true
          schema:
            type: integer
          description: Community ID
          example: 1
        - name: member_id
          in: path
          required: true
          schema:
            type: integer
          description: Member ID
          example: 1
        - name: num
          in: path
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 25
          description: Items per page (1-100)
          example: 25
        - name: page
          in: path
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number (starts from 1)
          example: 1
      responses:
        '200':
          description: Transactions retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                          example: 1
                        type:
                          type: string
                          enum: [income, expense]
                          example: income
                        date:
                          type: string
                          format: date
                          example: "2025-02-14"
                        reason:
                          type: string
                          example: "Salary"
                        amount:
                          type: string
                          example: "1000.50"
                        contributionPercentage:
                          type: integer
                          nullable: true
                          description: Only present for income records
                          example: 75
                        createdAt:
                          type: string
                          format: date-time
                          example: "2025-02-14 10:00:00"
                        updatedAt:
                          type: string
                          format: date-time
                          example: "2025-02-14 10:00:00"
                  pagination:
                    type: object
                    properties:
                      currentPage:
                        type: integer
                        example: 1
                      totalPages:
                        type: integer
                        example: 3
                      totalItems:
                        type: integer
                        example: 67
                      perPage:
                        type: integer
                        example: 25
        '400':
          description: Bad Request - invalid num or page parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized - missing or invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - user not in same community as requested member
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not Found - member does not exist
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /income:
    post:
      tags:
        - Income
      summary: Create income record
      description: Creates a new income record for the authenticated user
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - amount
                - reason
              properties:
                amount:
                  type: number
                  format: float
                  minimum: 0.01
                  description: Income amount (must be > 0)
                  example: 1000.50
                reason:
                  type: string
                  minLength: 1
                  description: Reason for income
                  example: Monthly salary
                date:
                  type: string
                  format: date
                  description: Income date (defaults to today if not provided)
                  example: '2025-02-14'
                contributionPercentage:
                  type: integer
                  minimum: 0
                  maximum: 100
                  description: Contribution percentage (defaults to member's current percentage)
                  example: 80
      responses:
        '201':
          description: Income created successfully
          headers:
            Location:
              description: URI of the created income resource (RFC 9110)
              schema:
                type: string
                example: /income/1
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                    description: ID of the created income record
                    example: 1
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - member not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /income/{id}:
    get:
      tags:
        - Income
      summary: Get income record by ID
      description: Retrieves an income record (accessible to all members in the same community)
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: Income record ID
          example: 1
      responses:
        '200':
          description: Income retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Income'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - not in same community
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Income not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags:
        - Income
      summary: Replace income record
      description: Replaces an income record with full data (only the owner can modify). All fields are required.
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: Income record ID
          example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - amount
                - reason
                - date
              properties:
                amount:
                  type: number
                  format: float
                  minimum: 0.01
                  description: Income amount (must be > 0)
                  example: 1200.00
                reason:
                  type: string
                  minLength: 1
                  description: Reason for income
                  example: Updated salary
                date:
                  type: string
                  format: date
                  description: Income date
                  example: '2025-02-15'
                contributionPercentage:
                  type: integer
                  minimum: 0
                  maximum: 100
                  description: Contribution percentage (defaults to current value if not provided)
                  example: 85
      responses:
        '200':
          description: Income updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Income'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - not the owner
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Income not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags:
        - Income
      summary: Delete income record
      description: Deletes an income record (only the owner can delete)
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: Income record ID
          example: 1
      responses:
        '204':
          description: Income deleted successfully
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - not the owner
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Income not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /expense:
    post:
      tags:
        - Expense
      summary: Create expense record
      description: Creates a new expense record for the authenticated user
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - amount
                - reason
              properties:
                amount:
                  type: number
                  format: float
                  minimum: 0.01
                  description: Expense amount (must be > 0)
                  example: 500.75
                reason:
                  type: string
                  minLength: 1
                  description: Reason for expense
                  example: Groceries
                date:
                  type: string
                  format: date
                  description: Expense date (defaults to today if not provided)
                  example: '2025-02-14'
      responses:
        '201':
          description: Expense created successfully
          headers:
            Location:
              description: URI of the created expense resource (RFC 9110)
              schema:
                type: string
                example: /expense/1
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                    description: ID of the created expense record
                    example: 1
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - member not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /expense/{id}:
    get:
      tags:
        - Expense
      summary: Get expense record by ID
      description: Retrieves an expense record (accessible to all members in the same community)
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: Expense record ID
          example: 1
      responses:
        '200':
          description: Expense retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Expense'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - not in same community
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Expense not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags:
        - Expense
      summary: Replace expense record
      description: Replaces an expense record with full data (only the owner can modify). All fields are required.
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: Expense record ID
          example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - amount
                - reason
                - date
              properties:
                amount:
                  type: number
                  format: float
                  minimum: 0.01
                  description: Expense amount (must be > 0)
                  example: 600.00
                reason:
                  type: string
                  minLength: 1
                  description: Reason for expense
                  example: Updated groceries
                date:
                  type: string
                  format: date
                  description: Expense date
                  example: '2025-02-15'
      responses:
        '200':
          description: Expense updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Expense'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - not the owner
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Expense not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags:
        - Expense
      summary: Delete expense record
      description: Deletes an expense record (only the owner can delete)
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: Expense record ID
          example: 1
      responses:
        '204':
          description: Expense deleted successfully
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - not the owner
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Expense not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token obtained from /login endpoint

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message
          example: Invalid credentials

    Income:
      type: object
      properties:
        id:
          type: integer
          example: 1
        memberId:
          type: integer
          description: Member ID who owns this income
          example: 1
        date:
          type: string
          format: date
          example: '2025-02-14'
        reason:
          type: string
          example: Monthly salary
        amount:
          type: string
          description: Amount as decimal string
          example: '1000.50'
        contributionPercentage:
          type: integer
          description: Percentage contributed to common account
          example: 80
        createdAt:
          type: string
          format: date-time
          example: '2025-02-14 10:30:00'
        updatedAt:
          type: string
          format: date-time
          example: '2025-02-14 10:30:00'

    Expense:
      type: object
      properties:
        id:
          type: integer
          example: 1
        memberId:
          type: integer
          description: Member ID who owns this expense
          example: 1
        date:
          type: string
          format: date
          example: '2025-02-14'
        reason:
          type: string
          example: Groceries
        amount:
          type: string
          description: Amount as decimal string
          example: '500.75'
        createdAt:
          type: string
          format: date-time
          example: '2025-02-14 10:30:00'
        updatedAt:
          type: string
          format: date-time
          example: '2025-02-14 10:30:00'
